# ADR-0002 相册级加密存储

状态：Accepted（MVP 范围内实现基础能力）
日期：2025-10-21

背景与动机
- 家庭场景下存在敏感相册（隐私、儿童照片等）。要求相册级别的“静态数据加密（encryption-at-rest）”。
- 管理员不可浏览内容，需配合受限视图与权限控制。

决策
- 加密粒度：以相册为单位，启用后相册内所有媒体文件使用对称密钥加密（AES-256-GCM）。
- 密钥管理：每个相册一个独立的 data_key；data_key 由用户主密钥 user_master_key 加密后存储（KEK 模式）。
- 主密钥来源：
  - 桌面：使用系统钥匙串/安全存储生成与持久化；用户解锁时解封装。
  - 移动端：后续里程碑再接入，本 MVP 以桌面侧加密为主。
- 预览策略：
  - MVP：不生成明文预览；若需预览，生成加密缩略图并随相册密钥管理。
- IO 路径：同步（M3）收到文件后进入加密队列，再落盘至相册目录；索引（M4）对加密文件进行哈希与元数据解析（解析前需解密或从侧带记录）。

实现要点
- 文件封装：采用标准容器（自定义头部：版本、算法、nonce、tag、原始扩展名）。
- 密钥轮换：支持相册级轮换；旧文件按需重加密（后台任务）。
- 备份与恢复：密钥材料与索引同步备份；恢复需用户解锁。
- 错误与告警：解密失败、完整性校验失败需告警并隔离文件。

取舍与影响
- 优点：明确边界，提升隐私安全；与管理员受限视图协同。
- 代价：CPU消耗与预览体验可能下降；通过后台任务与缓存优化。
- 风险：密钥丢失即不可恢复；通过钥匙串与备份降低风险。

关联
- 里程碑：M3（加密队列）、M4（索引解析）、M8（安全策略）
- 文档：M8 隐私与安全的验收标准更新