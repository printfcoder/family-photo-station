# ADR-0001 多用户目录隔离

状态：Accepted（MVP）
日期：2025-10-21

背景与动机
- 家庭场景需要在同一库根下为不同用户提供数据隔离与权限边界，避免相互可见与串权。
- 需与首启向导（M2）、同步（M3）、索引（M4）、浏览（M5）、备份（M7）、隐私安全（M8）协同。

决策
- 目录布局：在库根下为每个用户建立独立子目录，命名为 /LibraryRoot/{user_id}/，禁止相对路径持久化，统一使用绝对路径。
- user_id：注册/配对时生成稳定唯一ID（UUIDv4），保存在配置与索引库中；不可复用、不可重置（除删除用户流程）。
- 权限边界：非管理员用户仅可访问自身目录与索引记录；管理员仅可见用户清单与媒体计数，不可浏览具体内容与预览。
- 索引分区：SQLite 中按用户维度分区/外键约束（photo.user_id、album.user_id），查询默认带 user_id 过滤。
- 备份/恢复：用户目录与索引分用户打包；恢复时需验证 user_id 映射；禁止跨用户混合恢复。
- 配对绑定：设备令牌与特定 user_id 绑定；同设备可绑定多个用户需要明确多令牌（后续增强，MVP不支持）。

实现要点
- 配置结构（示例）：
  - library_root: string（绝对路径）
  - users: [{ user_id, name, dir_abs_path, role }]
  - tokens: [{ device_id, user_id, token_id, expires_at }]
- 索引库：对所有核心表增加 user_id 字段并建立联合索引（例如 photo(user_id, taken_at)、album(user_id, updated_at)）。
- 访问控制：GetX 控制器持有当前 user_id，上层查询统一注入过滤条件；管理员视图单独实现聚合统计接口。
- 迁移策略：若已有单用户数据，迁移脚本将其归档至默认 user_id 并建立目录。

取舍与影响
- 优点：清晰的物理隔离，降低误操作风险，备份/恢复更简单。
- 代价：用户间共享需要额外机制（后续里程碑实现 LAN 分享/受邀访问）。
- 风险：user_id 管理与目录一致性；通过配置校验与启动自检降低风险。

关联
- 里程碑：M2/M3/M4/M5/M7/M8
- 文档：MVP-scope、M2/M8 更新的约束与验收标准